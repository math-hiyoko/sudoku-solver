version: 0.2

env:
  git-credential-helper: yes

phases:
  install:
    commands:
      - echo "Installing dependencies..."
      - yum -y update
      - yum -y install cmake gcc boost-devel boost-json

  pre_build:
    commands:
      - echo "Setting up the environment..."
      - export VERSION=$(grep -oP '\[\K[0-9]+\.[0-9]+\.[0-9]+' CHANGELOG.md | head -1)
      - |
        if [ "$CODEBUILD_WEBHOOK_TRIGGER" == "branch/main" ]; then
          export CMAKE_BUILD_TYPE="Release"
          export GIT_REVISION=$(git rev-list HEAD --count)
          export ARTIFACT_NAME="SudokuLambda-${CMAKE_BUILD_TYPE}-${VERSION}-${GIT_REVISION}"
        else
          export CMAKE_BUILD_TYPE="Debug"
          export DATE=$(date +%Y%m%d%H%M%S)
          export ARTIFACT_NAME="SudokuLambda-${CMAKE_BUILD_TYPE}-${VERSION}-${DATE}"
        fi
      - echo "CMAKE_BUILD_TYPE=$CMAKE_BUILD_TYPE"
      - echo "VERSION=$VERSION"
      - echo "ARTIFACT_NAME=$ARTIFACT_NAME"

  build:
    commands:
      - echo "Building external projects..."
      - |
        cd $CODEBUILD_SRC_DIR/backend/extern/aws-lambda-cpp
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=$CMAKE_BUILD_TYPE -DBUILD_SHARED_LIBS=OFF -DCMAKE_INSTALL_PREFIX=$CODEBUILD_SRC_DIR/backend
        make && make install
      - echo "Building the application..."
      - |
        cd $CODEBUILD_SRC_DIR/backend
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=$CMAKE_BUILD_TYPE -DCMAKE_PREFIX_PATH=$CODEBUILD_SRC_DIR/backend
        make && make aws-lambda-package-SudokuLambda
      - echo "Running Tests..."
      - ctest -V || exit 1

  post_build:
    commands:
      - |
        if [ "$CODEBUILD_WEBHOOK_TRIGGER" == "branch/main" ]; then
          echo "Tagging the version..."
          git tag ${VERSION}-${GIT_REVISION}
          git push origin ${VERSION}-${GIT_REVISION}
          echo "Tagged the version: ${VERSION}-${GIT_REVISION}"
          echo "Uploading to aws lambda"
          aws lambda update-function-code --function-name SudokuSolverBackend --zip-file fileb://$CODEBUILD_SRC_DIR/backend/build/src/handler/SudokuLambda.zip
        fi

reports:
  unittest_reports:
    files: backend/build/tests/unittest_reports/unittest.xml
    file-format: JUnit

artifacts:
  files: backend/build/src/handler/SudokuLambda.zip
  name: $ARTIFACT_NAME
  discard-paths: yes
